#!/bin/bash
# Cargamos la configuracion
CONFIG_PATHS="/etc/hpqc/hpqc.config ~/.hpqc/hpqc.config ./hpqc.config"
for file in ${CONFIG_PATHS}; do
	expanded_file=$(bash -c "echo $file")
	[ -f ${expanded_file} ] && . $expanded_file
done

PLUGIN="$1"
shift

# Look for views in
function getView
{
	VIEW=$1
	for path in ${VIEW_PATH}; do
		expanded_path=$(bash -c "echo $path")
		if [ -f "${expanded_path}/${VIEW}.view" ]; then
			RESULT="${expanded_path}/${VIEW}.view"
		fi
	done

	echo ${RESULT}
}

function getSearch
{
	SEARCH=$1
	for path in ${SEARCH_PATH}; do
		expanded_path=$(bash -c "echo $path")
		if [ -f "${expanded_path}/${SEARCH}.search" ]; then
			RESULT="${expanded_path}/${SEARCH}.search"
		fi
	done

	echo ${RESULT}
}

function getFilter
{
	FILTER=$1
	for path in ${FILTER_PATH}; do
		expanded_path=$(bash -c "echo $path")
		if [ -f "${expanded_path}/${FILTER}.xsl" ]; then
			RESULT="${expanded_path}/${FILTER}.xsl"
		fi
	done

	echo ${RESULT}
}

function getPlugin
{
	PLUGIN=$1
	for path in ${PLUGIN_PATH}; do
		expanded_path=$(bash -c "echo $path")
		if [ -f "${expanded_path}/hpqc-${PLUGIN}" ]; then
			RESULT="${expanded_path}/hpqc-${PLUGIN}"
		fi
	done

	echo ${RESULT}
}

function downloadEntities
{
	URL=$1
	TMP_FILE=$(mktemp /tmp/entities_donload.XXXXXXXXXX)
	curl -D ${HEAD} --cookie ${COOKIES} --cookie-jar ${COOKIES} -g "${URL}" > ${TMP_FILE}

	# Test if we have to paginate
	TOTAL_RESULT=$(xsltproc $(getFilter total_results) ${TMP_FILE})
	if [ $TOTAL_RESULT -gt $MAX_DEFECTS ]; then
		DOWNLOADED=${MAX_DEFECTS}
	else
		DONLOADED=${TOTAL_RESULT}
	fi

	PAGES=$((${TOTAL_RESULT} / ${MAX_DEFECTS}))
	if [ $((${TOTAL_RESULT} % ${MAX_DEFECTS})) != 0 ]; then
		PAGES=$(($PAGES + 1))
	fi
}

plugin=$(getPlugin ${PLUGIN})
if [ -z "${plugin}" ]; then
	echo "Debe asignar un plugin adecuado"
	exit 1
fi

. ${plugin} "$@"
